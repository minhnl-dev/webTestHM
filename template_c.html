<!-- Site A: index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Site A</title>
</head>
<body>
<div class="mieruca-optimize-image-upload">
  <div class="fileinput-image"><input class="file-input-image" type="file"
                                      accept="image/gif, image/jpeg, image/png, image/jfif, image/jpg, image/webp"><span>画像をアップロード</span>
  </div>
  <div class="mieruca-optimize-attr">
    <div class="mieruca-optimize-attr-item">
      <p>width</p>
      <div class="mieruca-optimize-flex">
        <input type="text" id="mieruca_optimize_image_width">
        <select name="">
          <option value="px">px</option>
          <option value="em">em</option>
        </select>
      </div>
    </div>
    <div class="mieruca-optimize-attr-item">
      <p>height</p>
      <div class="mieruca-optimize-flex">
        <input type="text" id="mieruca_optimize_image_height">
        <select name="" id="">
          <option value="px">px</option>
          <option value="em">em</option>
        </select>
      </div>
    </div>
  </div>
  <div class="mieruca-optimize-alt">
    <p>alt 属性</p>
    <input type="text" placeholder="alt属性名を入力" id="mieruca_optimize_image_alt">
  </div>
</div>

<script>
  $('.file-input-image').on('change', function(event) {
    var file = event.target.files[0];
    if (file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        const arrayBuffer = event.target.result;
        const message = {
          action: 'IMAGE_UPLOAD',
          type: 'fileUpload',
          file: arrayBuffer,
          fileName: file.name,
          fileType: file.type
        };
        opener.postMessage(message, 'https://app.mieru-ca.com');
        var img = new Image();
        img.onload = function() {
          var width = img.width;
          var height = img.height;
          $('#mieruca_optimize_image_width').val(width);
          $('#mieruca_optimize_image_height').val(height);
        };
      };
      reader.readAsDataURL(file);
    }
  });

  window.addEventListener('message', (event) => {
    if (event.origin !== 'https://app.mieru-ca.com') return;

    $('#mieruca_optimize_image_link').val(event.data.imageSrc);
    $('#mieruca_optimize_image_link_src').attr('src', event.data.imageSrc);
    $('#mieruca_optimize_image_alt').val(event.data.imageName);
  });
</script>
</body>
</html>
